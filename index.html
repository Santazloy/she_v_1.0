<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shanghai Schedule</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(18, 18, 26, 0.8);
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-pink: #ec4899;
            --accent-green: #10b981;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.4);
            --border-color: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --glow-purple: rgba(139, 92, 246, 0.4);
            --glow-blue: rgba(59, 130, 246, 0.4);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 10% 80%, rgba(6, 182, 212, 0.08) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
            animation: bgPulse 15s ease-in-out infinite alternate;
        }

        @keyframes bgPulse {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.8; transform: scale(1.05); }
        }

        /* ========== LOGIN SCREEN ========== */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-card);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--border-color);
            border-radius: 28px;
            padding: 50px 40px;
            width: 100%;
            max-width: 420px;
            box-shadow:
                0 25px 50px rgba(0, 0, 0, 0.4),
                0 0 100px rgba(139, 92, 246, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            animation: loginAppear 0.6s ease-out;
        }

        @keyframes loginAppear {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 25px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 10px 40px var(--glow-purple);
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .login-title {
            text-align: center;
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .login-subtitle {
            text-align: center;
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 35px;
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .login-input {
            width: 100%;
            padding: 18px 18px 18px 52px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            background: rgba(139, 92, 246, 0.05);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        .login-input:focus + .input-icon,
        .login-input:not(:placeholder-shown) + .input-icon {
            opacity: 1;
        }

        .login-input::placeholder {
            color: var(--text-muted);
        }

        .login-button {
            width: 100%;
            padding: 18px;
            margin-top: 10px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border: none;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px var(--glow-purple);
            position: relative;
            overflow: hidden;
        }

        .login-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .login-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 50px var(--glow-purple);
        }

        .login-button:hover::before {
            left: 100%;
        }

        .login-button:active {
            transform: translateY(-1px);
        }

        .error-msg {
            color: #f87171;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 500;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* ========== MAIN APP ========== */
        .app-container {
            display: none;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* ========== HEADER ========== */
        .header {
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .time-display-inner {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, rgba(255,255,255,0.7));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
            font-variant-numeric: tabular-nums;
        }

        .weather-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .weather-temp {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .weather-icon {
            font-size: 20px;
        }

        .weather-precip {
            font-size: 12px;
            color: var(--accent-cyan);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .header-btn {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--accent-purple);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.2);
        }

        .header-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .header-btn svg {
            width: 22px;
            height: 22px;
        }

        .header-btn svg path {
            fill: url(#iconGradient);
        }

        .header-btn:hover svg path {
            fill: url(#iconGradientHover);
        }

        .header-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.2);
        }

        .escort-btn {
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid var(--accent-pink);
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(139, 92, 246, 0.2));
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .escort-btn:hover {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.4), rgba(139, 92, 246, 0.4));
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(236, 72, 153, 0.3);
        }

        .menu-container {
            position: relative;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(18, 18, 26, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 4px;
            min-width: 180px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .menu-dropdown.show {
            display: flex;
            animation: menuAppear 0.2s ease-out;
        }

        @keyframes menuAppear {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            text-align: left;
        }

        .menu-item:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .menu-item-icon {
            font-size: 18px;
        }

        .date-display {
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* ========== DATE TABS ========== */
        .date-tabs {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            background: rgba(18, 18, 26, 0.5);
            border-bottom: 1px solid var(--border-color);
        }

        .date-tab {
            flex: 1;
            text-align: center;
            padding: 14px 20px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.02);
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            border-radius: 14px;
            transition: all 0.3s ease;
            position: relative;
        }

        .date-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border-hover);
        }

        .date-tab.active {
            color: #fff;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border-color: var(--accent-purple);
            box-shadow: 0 5px 25px rgba(139, 92, 246, 0.15);
        }

        /* ========== SCHEDULE TABLE ========== */
        .schedule-container {
            padding: 20px;
        }

        .schedule-grid {
            display: table;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        }

        .schedule-row {
            display: table-row;
        }

        .schedule-row:not(:last-child) .schedule-cell {
            border-bottom: 1px solid var(--border-color);
        }

        .schedule-cell {
            display: table-cell;
            padding: 12px 10px;
            border-right: 1px solid var(--border-color);
            vertical-align: middle;
            text-align: center;
            transition: background 0.2s;
        }

        .schedule-cell:last-child {
            border-right: none;
        }

        /* Table Header */
        .table-header {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.1));
        }

        .table-header .schedule-cell {
            font-weight: 700;
            font-size: 18px;
            padding: 18px 12px;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
        }

        /* Time Column */
        .time-cell {
            background: rgba(0, 0, 0, 0.3);
            font-size: 13px;
            color: var(--text-muted);
            width: 65px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        /* Data Cells */
        .data-cell {
            min-height: 50px;
            position: relative;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .data-cell:hover {
            background: rgba(139, 92, 246, 0.08);
        }

        /* Cell Inputs */
        .cell-input {
            width: 100%;
            height: 100%;
            min-height: 50px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            text-align: center;
            font-size: 14px;
            font-family: inherit;
            padding: 8px;
            transition: all 0.2s;
        }

        .cell-input:focus {
            outline: none;
            background: rgba(139, 92, 246, 0.1);
            box-shadow: inset 0 0 0 2px var(--accent-purple);
        }

        .cell-input::placeholder {
            color: var(--text-muted);
        }

        /* Address Row */
        .address-row {
            background: rgba(0, 0, 0, 0.4);
        }

        .address-row .data-cell {
            background: transparent;
        }

        .address-input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            text-align: center;
            font-size: 12px;
            font-family: inherit;
            padding: 12px 6px;
            transition: all 0.2s;
        }

        .address-input:focus {
            outline: none;
            background: rgba(139, 92, 246, 0.08);
            color: #fff;
        }

        /* ========== NOTES SECTION ========== */
        .permanent-notes-section {
            margin: 20px;
            padding: 24px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
        }

        .notes-label {
            font-size: 14px;
            color: var(--accent-green);
            margin-bottom: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notes-input {
            width: 100%;
            min-height: 120px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            padding: 18px;
            resize: vertical;
            line-height: 1.6;
            -webkit-user-select: text;
            user-select: text;
            transition: all 0.3s;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.05);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .notes-input::placeholder {
            color: var(--text-muted);
        }

        /* ========== DIALOGS ========== */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            z-index: 150;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .overlay.show {
            display: block;
            opacity: 1;
        }

        .add-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-color);
            border-radius: 28px;
            padding: 35px;
            display: none;
            z-index: 200;
            box-shadow:
                0 25px 80px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(139, 92, 246, 0.1);
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 340px;
        }

        .add-dialog.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .dialog-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
            background: linear-gradient(135deg, #fff, rgba(255,255,255,0.7));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .table-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .table-option {
            padding: 18px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .table-option:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--accent-purple);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
        }

        .table-option:active {
            transform: translateY(0);
        }

        .table-option.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .close-dialog {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 14px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 15px;
            transition: all 0.3s;
        }

        .close-dialog:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* ========== ACTIVITY LOG ========== */
        .activity-log-dialog {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 65vh;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(30px);
            border-top: 1px solid var(--accent-purple);
            padding: 24px;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 95;
            box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.5);
            border-radius: 28px 28px 0 0;
        }

        .activity-log-dialog.show {
            transform: translateY(0);
        }

        .activity-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-log-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #fff, rgba(255,255,255,0.7));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-log-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-log-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .log-entry {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 10px 0;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid var(--accent-green);
            border-radius: 12px;
            line-height: 1.5;
            transition: all 0.2s;
        }

        .log-entry:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px);
        }

        .log-entry .time {
            color: var(--accent-green);
            font-weight: 700;
            margin-right: 10px;
            font-variant-numeric: tabular-nums;
        }

        /* ========== LOGOUT DIALOG ========== */
        .logout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 240;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .logout-overlay.show {
            display: block;
            opacity: 1;
        }

        .logout-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-color);
            border-radius: 28px;
            padding: 40px;
            display: none;
            z-index: 250;
            box-shadow:
                0 25px 80px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(239, 68, 68, 0.1);
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 340px;
            text-align: center;
        }

        .logout-dialog.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .logout-dialog-icon {
            font-size: 56px;
            margin-bottom: 20px;
            display: block;
            animation: doorWiggle 2s ease-in-out infinite;
        }

        @keyframes doorWiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .logout-dialog-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #f87171, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logout-dialog-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .logout-dialog-buttons {
            display: flex;
            gap: 12px;
        }

        .logout-btn {
            flex: 1;
            padding: 16px 24px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .logout-btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .logout-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: translateY(-2px);
        }

        .logout-btn-confirm {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }

        .logout-btn-confirm:hover {
            background: linear-gradient(135deg, #f87171, #ef4444);
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4);
        }

        .logout-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .login-box {
                padding: 40px 28px;
            }

            .schedule-container {
                padding: 12px;
            }

            .schedule-cell {
                font-size: 12px;
                padding: 8px 5px;
            }

            .table-header .schedule-cell {
                font-size: 14px;
                padding: 14px 8px;
            }

            .time-cell {
                font-size: 11px;
                width: 50px;
            }

            .cell-input {
                font-size: 12px;
                min-height: 44px;
            }

            .permanent-notes-section {
                margin: 12px;
                padding: 18px;
            }

            .header-btn {
                width: 42px;
                height: 42px;
                font-size: 18px;
            }

            .time-display-inner {
                font-size: 36px;
            }

            .date-tabs {
                padding: 12px;
                gap: 6px;
            }

            .date-tab {
                padding: 12px 8px;
                font-size: 14px;
            }
        }

        /* ========== SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ========== BOTTOM TICKER BAR ========== */
        .ticker-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--accent-purple);
            display: flex;
            align-items: center;
            z-index: 100;
            overflow: hidden;
            box-shadow: 0 -5px 30px rgba(139, 92, 246, 0.15);
        }

        .ticker-content {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
        }

        .ticker-text {
            display: inline-block;
            padding-left: 100%;
            animation: ticker 20s linear infinite;
            color: #fff;
            font-size: 15px;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .ticker-text:empty {
            animation: none;
        }

        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* ========== TICKER EDIT DIALOG ========== */
        .ticker-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-card);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--border-color);
            border-radius: 28px;
            padding: 35px;
            display: none;
            z-index: 200;
            box-shadow:
                0 25px 80px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(139, 92, 246, 0.1);
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 340px;
            max-width: 90vw;
        }

        .ticker-dialog.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .ticker-input {
            width: 100%;
            padding: 18px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            border-radius: 16px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .ticker-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            background: rgba(139, 92, 246, 0.05);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        .ticker-buttons {
            display: flex;
            gap: 12px;
        }

        .ticker-btn {
            flex: 1;
            padding: 16px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .ticker-btn-save {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            color: #fff;
            box-shadow: 0 10px 30px var(--glow-purple);
        }

        .ticker-btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px var(--glow-purple);
        }

        .ticker-btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .ticker-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* Add padding to schedule container for ticker bar */
        .schedule-container {
            padding-bottom: 70px;
        }

        /* ========== MUSIC PLAYER MODAL ========== */
        .music-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            display: none;
            z-index: 300;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .music-modal.show {
            display: flex;
            flex-direction: column;
            opacity: 1;
        }

        .music-player {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .music-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .music-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, rgba(255,255,255,0.7));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .music-close {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .music-close:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .now-playing {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .now-playing-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .now-playing-artist {
            font-size: 13px;
            color: var(--text-muted);
        }

        .music-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .control-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--accent-purple);
            transform: scale(1.1);
        }

        .control-btn.play-btn {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border: none;
            font-size: 28px;
            box-shadow: 0 10px 30px var(--glow-purple);
        }

        .control-btn.play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px var(--glow-purple);
        }

        .playlist-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .playlist-item.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border: 1px solid var(--accent-purple);
        }

        .playlist-thumb {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-secondary);
        }

        .playlist-info {
            flex: 1;
            overflow: hidden;
        }

        .playlist-item-title {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .playlist-item-artist {
            font-size: 12px;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .playlist-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* ========== LOADING STATE ========== */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <!-- SVG Gradients for Icons -->
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <linearGradient id="iconGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#8b5cf6"/>
                <stop offset="100%" style="stop-color:#3b82f6"/>
            </linearGradient>
            <linearGradient id="iconGradientHover" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#a78bfa"/>
                <stop offset="100%" style="stop-color:#60a5fa"/>
            </linearGradient>
        </defs>
    </svg>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">üóìÔ∏è</div>
            <h1 class="login-title">Shanghai Schedule</h1>
            <p class="login-subtitle">‰∏äÊµ∑ÊéíÁè≠Á≥ªÁªü</p>

            <div class="input-group">
                <input type="text" class="login-input" id="username" placeholder="Username / Áî®Êà∑Âêç">
                <span class="input-icon">üë§</span>
            </div>

            <div class="input-group">
                <input type="password" class="login-input" id="password" placeholder="Password / ÂØÜÁ†Å">
                <span class="input-icon">üîí</span>
            </div>

            <button class="login-button" onclick="login()">Login / ÁôªÂΩï</button>
            <div class="error-msg" id="errorMsg"></div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <button class="header-btn" onclick="showDeleteDialog()" title="–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü">
                    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M15 1H1V15H15V1ZM4 7V9L12 9V7L4 7Z"/>
                    </svg>
                </button>
                <button class="header-btn" onclick="showAddDialog()" title="–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü">
                    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M15 1H1V15H15V1ZM7 4H9V7H12V9H9V12H7V9H4V7H7V4Z"/>
                    </svg>
                </button>
                <button class="header-btn" id="musicBtn" onclick="toggleMusic()" title="–ú—É–∑—ã–∫–∞">
                    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 1H4V9H3C1.34315 9 0 10.3431 0 12C0 13.6569 1.34315 15 3 15C4.65685 15 6 13.6569 6 12V5H13V9H12C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12V1Z"/>
                    </svg>
                </button>
                <span class="time-display-inner" id="timeDisplay">00:00</span>
                <div class="weather-display" id="weatherDisplay" title="Shanghai Weather">
                    <span class="weather-icon" id="weatherIcon">--</span>
                    <span class="weather-temp" id="weatherTemp">--¬∞</span>
                    <span class="weather-precip" id="weatherPrecip"></span>
                </div>
                <button class="header-btn" onclick="window.location.href='https://eurogirlsshanghai.com'" title="Escort">
                    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M13 7C13 9.41896 11.2822 11.4367 9 11.9V14H12V16H4V14H7V11.9C4.71776 11.4367 3 9.41896 3 7V6.89072C3 6.63062 3.01986 6.3709 3.05941 6.11382L4 0H12L12.9406 6.11382C12.9801 6.3709 13 6.63062 13 6.89072V7ZM5.2543 5H10.7457L10.2842 2H5.71584L5.2543 5Z"/>
                    </svg>
                </button>
                <div class="menu-container">
                    <button class="header-btn" onclick="toggleMenu()" title="–ú–µ–Ω—é">
                        <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M6.50001 0H9.50001L10.0939 2.37548C10.7276 2.6115 11.3107 2.95155 11.8223 3.37488L14.1782 2.70096L15.6782 5.29904L13.9173 7.00166C13.9717 7.32634 14 7.65987 14 8C14 8.34013 13.9717 8.67366 13.9173 8.99834L15.6782 10.701L14.1782 13.299L11.8223 12.6251C11.3107 13.0484 10.7276 13.3885 10.0939 13.6245L9.50001 16H6.50001L5.90614 13.6245C5.27242 13.3885 4.68934 13.0484 4.17768 12.6251L1.82181 13.299L0.321808 10.701L2.08269 8.99834C2.02831 8.67366 2.00001 8.34013 2.00001 8C2.00001 7.65987 2.02831 7.32634 2.08269 7.00166L0.321808 5.29904L1.82181 2.70096L4.17768 3.37488C4.68934 2.95155 5.27241 2.6115 5.90614 2.37548L6.50001 0ZM8.00001 10C9.10458 10 10 9.10457 10 8C10 6.89543 9.10458 6 8.00001 6C6.89544 6 6.00001 6.89543 6.00001 8C6.00001 9.10457 6.89544 10 8.00001 10Z"/>
                        </svg>
                    </button>
                    <div class="menu-dropdown" id="menuDropdown">
                        <button class="menu-item" onclick="toggleActivityLog(); closeMenu()">
                            <span class="menu-item-icon">üìã</span> –ñ—É—Ä–Ω–∞–ª
                        </button>
                        <button class="menu-item" id="tickerMenuItem" onclick="showTickerDialog(); closeMenu()" style="display:none;">
                            <span class="menu-item-icon">üìù</span> –ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞
                        </button>
                        <button class="menu-item danger" onclick="showLogoutDialog(); closeMenu()">
                            <span class="menu-item-icon">üö™</span> –í—ã—Ö–æ–¥
                        </button>
                    </div>
                </div>
            </div>
            <div class="date-display" id="dateDisplay"></div>
        </div>

        <!-- Date Tabs -->
        <div class="date-tabs">
            <button class="date-tab active" onclick="switchDate(0)" id="tab0">--</button>
            <button class="date-tab" onclick="switchDate(1)" id="tab1">--</button>
            <button class="date-tab" onclick="switchDate(2)" id="tab2">--</button>
        </div>

        <!-- Schedule Container -->
        <div class="schedule-container" id="scheduleContainer"></div>

        <!-- Add Table Dialog -->
        <div class="overlay" id="overlay" onclick="hideAddDialog()"></div>
        <div class="add-dialog" id="addDialog">
            <h3 class="dialog-title">ÈÄâÊã©Ê°åÂè∞Âè∑</h3>
            <div class="table-options">
                <div class="table-option" onclick="addTable('000')">000</div>
                <div class="table-option" onclick="addTable('111')">111</div>
                <div class="table-option" onclick="addTable('222')">222</div>
                <div class="table-option" onclick="addTable('333')">333</div>
                <div class="table-option" onclick="addTable('555')">555</div>
                <div class="table-option" onclick="addTable('666')">666</div>
                <div class="table-option" onclick="addTable('888')">888</div>
                <div class="table-option" onclick="addTable('999')">999</div>
                <div class="table-option" onclick="addTable('Âåó‰∫¨1')">Âåó‰∫¨1</div>
                <div class="table-option" onclick="addTable('Âåó‰∫¨2')">Âåó‰∫¨2</div>
            </div>
            <button class="close-dialog" onclick="hideAddDialog()">Cancel / ÂèñÊ∂à</button>
        </div>

        <!-- Delete Table Dialog -->
        <div class="add-dialog" id="deleteDialog">
            <h3 class="dialog-title">ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊ°åÂè∞</h3>
            <div class="table-options" id="deleteOptions"></div>
            <button class="close-dialog" onclick="hideDeleteDialog()">Cancel / –û—Ç–º–µ–Ω–∞</button>
        </div>

        <!-- Activity Log Dialog -->
        <div class="activity-log-dialog" id="activityLogDialog">
            <div class="activity-log-header">
                <div class="activity-log-title">üìã Activity Log / –ñ—É—Ä–Ω–∞–ª</div>
                <button class="close-log-btn" onclick="toggleActivityLog()">‚úï</button>
            </div>
            <div id="activityLog"></div>
        </div>

        <!-- Logout Confirmation Dialog -->
        <div class="logout-overlay" id="logoutOverlay" onclick="hideLogoutDialog()"></div>
        <div class="logout-dialog" id="logoutDialog">
            <span class="logout-dialog-icon">üö™</span>
            <div class="logout-dialog-title">Logout / ÈÄÄÂá∫</div>
            <div class="logout-dialog-subtitle">Are you sure?<br>–í—ã —É–≤–µ—Ä–µ–Ω—ã? / ‰Ω†Á°ÆÂÆöÂêó?</div>
            <div class="logout-dialog-buttons">
                <button class="logout-btn logout-btn-cancel" onclick="hideLogoutDialog()">No / –ù–µ—Ç</button>
                <button class="logout-btn logout-btn-confirm" onclick="confirmLogout()">Yes / –î–∞</button>
            </div>
        </div>

        <!-- Ticker Edit Dialog -->
        <div class="ticker-dialog" id="tickerDialog">
            <h3 class="dialog-title">üìù –ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞</h3>
            <input type="text" class="ticker-input" id="tickerInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –±–µ–≥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏...">
            <div class="ticker-buttons">
                <button class="ticker-btn ticker-btn-cancel" onclick="hideTickerDialog()">–û—Ç–º–µ–Ω–∞</button>
                <button class="ticker-btn ticker-btn-save" onclick="saveTickerText()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <!-- Bottom Ticker Bar -->
        <div class="ticker-bar">
            <div class="ticker-content">
                <span class="ticker-text" id="tickerText"></span>
            </div>
        </div>

        <!-- Hidden YouTube Player -->
        <div id="youtubePlayerContainer" style="position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;overflow:hidden;">
            <div id="youtubePlayer"></div>
        </div>

        <!-- Music Player Modal -->
        <div class="music-modal" id="musicModal">
            <div class="music-player">
                <div class="music-header">
                    <span class="music-title">üéµ Music Player</span>
                    <button class="music-close" onclick="closeMusicModal()">‚úï</button>
                </div>
                <div class="now-playing">
                    <div class="now-playing-title" id="nowPlayingTitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫</div>
                    <div class="now-playing-artist" id="nowPlayingArtist"></div>
                </div>
                <div class="music-controls">
                    <button class="control-btn" onclick="prevTrack()">‚èÆ</button>
                    <button class="control-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂</button>
                    <button class="control-btn" onclick="nextTrack()">‚è≠</button>
                </div>
                <div class="playlist-container" id="playlistContainer">
                    <div class="playlist-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const _d = s => atob(s);
        const _s = {
            [_d('a3Jpcw==')]: _d('MTIzNDQzMjE='),
            [_d('bWlzaGE=')]: _d('MTIzNDQzMjE='),
            [_d('a2F0eWE=')]: _d('MTIzNDQzMjE='),
            [_d('d2FuZw==')]: _d('MTIzNDQzMjE='),
            [_d('bGlvbg==')]: _d('MTIzNDQzMjE='),
            [_d('YWxleGE=')]: _d('MDkwOTA5'),
            [_d('Ymo=')]: _d('MTIxMjEy')
        };
        const USERS = _s;

        const TIME_SLOTS = [
            '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
            '18:00', '19:00', '20:00', '21:00', '22:00', '23:00',
            '00:00', '01:00', '02:00'
        ];

        // API base URL
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : window.location.origin;

        // Security: HTML escaping to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // State
        let currentUser = null;
        let currentDate = 0;
        let scheduleData = {};
        let activityLog = [];
        let activeDates = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkSavedLogin();
            startClock();
            loadFromServer();

            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
            document.getElementById('username').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('password').focus();
            });

            startAutoRefresh();
        });

        function getNextThreeDates() {
            const dates = [];
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));

            if (now.getHours() < 4) {
                now.setDate(now.getDate() - 1);
            }

            for (let i = 0; i < 3; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() + i);

                const month = date.getMonth() + 1;
                const day = date.getDate();

                dates.push({
                    key: `${date.getFullYear()}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
                    display: `${day}.${month}`
                });
            }

            return dates;
        }

        function startClock() {
            updateClock();
            setInterval(updateClock, 1000);
        }

        function updateClock() {
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            if (document.getElementById('timeDisplay')) {
                document.getElementById('timeDisplay').textContent = `${hours}:${minutes}`;
            }
        }

        function checkSavedLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && USERS[savedUser]) {
                currentUser = savedUser;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateDateDisplay();
                renderSchedule();
                updateTickerEditButton();
            }
        }

        function login() {
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;

            if (USERS[username] && USERS[username] === password) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateDateDisplay();
                renderSchedule();
                updateTickerEditButton();
                logActivity(`${username} logged in`);
            } else {
                document.getElementById('errorMsg').textContent = 'Invalid credentials / Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ';
                setTimeout(() => {
                    document.getElementById('errorMsg').textContent = '';
                }, 3000);
            }
        }

        async function loadFromServer() {
            try {
                const response = await fetch(`${API_BASE}/api/schedule`);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }

                const data = await response.json();

                scheduleData = data.scheduleData || {};
                activityLog = data.activityLog || [];
                activeDates = data.activeDates || getNextThreeDates();

                updateDateDisplay();
                renderSchedule();
                updateLogDisplay();

            } catch (error) {
                console.error('Failed to load from server:', error);
                alert('Connection error / –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        async function saveToServer() {
            try {
                const response = await fetch(`${API_BASE}/api/schedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scheduleData,
                        activityLog,
                        user: currentUser
                    })
                });

                if (!response.ok) {
                    console.error('Server responded with error:', response.status);
                }
            } catch (error) {
                console.error('Failed to save to server:', error);
            }
        }

        function startAutoRefresh() {
            setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/schedule`);
                    if (response.ok) {
                        const data = await response.json();
                        if (JSON.stringify(data.scheduleData) !== JSON.stringify(scheduleData)) {
                            scheduleData = data.scheduleData;
                            activityLog = data.activityLog || [];
                            renderSchedule();
                            updateLogDisplay();
                        }
                    }
                } catch (error) {
                    console.error('Auto-refresh failed:', error);
                }
            }, 2000);
        }

        function updateDateDisplay() {
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            document.getElementById('tab0').textContent = dates[0].display;
            document.getElementById('tab1').textContent = dates[1].display;
            document.getElementById('tab2').textContent = dates[2].display;

            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const dateStr = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} ‚Äî Shanghai Time`;
            document.getElementById('dateDisplay').textContent = dateStr;
        }

        function switchDate(index) {
            currentDate = index;
            document.querySelectorAll('.date-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab${index}`).classList.add('active');
            renderSchedule();
        }

        function renderSchedule() {
            const container = document.getElementById('scheduleContainer');
            if (!container) return;

            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey]) {
                scheduleData[dateKey] = { tables: [], slots: {} };
            }

            const currentData = scheduleData[dateKey];
            const tables = currentData.tables || [];

            let html = '<div class="schedule-grid">';

            // Header row
            html += '<div class="schedule-row table-header">';
            html += '<div class="schedule-cell time-cell">Time</div>';
            tables.forEach(table => {
                html += `<div class="schedule-cell">${table}</div>`;
            });
            html += '</div>';

            // Address row
            html += '<div class="schedule-row address-row">';
            html += '<div class="schedule-cell time-cell">üìç</div>';
            tables.forEach(table => {
                const address = escapeHtml(scheduleData.sharedAddresses?.[table] || '');
                html += `<div class="schedule-cell data-cell">
                    <input type="text" class="address-input"
                        placeholder="Address"
                        value="${address}"
                        onchange="updateAddress('${escapeHtml(table)}', this.value)">
                </div>`;
            });
            html += '</div>';

            // Time slots
            TIME_SLOTS.forEach(time => {
                html += '<div class="schedule-row">';
                html += `<div class="schedule-cell time-cell">${time}</div>`;

                tables.forEach(table => {
                    const value = currentData.slots?.[table]?.[time] || '';
                    const escapedValue = escapeHtml(value);

                    html += `<div class="schedule-cell data-cell">
                        <input type="text" class="cell-input"
                            value="${escapedValue}"
                            onchange="updateSlot('${escapeHtml(table)}', '${escapeHtml(time)}', this.value)"
                            onfocus="this.select()">
                    </div>`;
                });

                html += '</div>';
            });

            html += '</div>';

            container.innerHTML = html;

            // Update ticker text
            updateTickerDisplay();
        }

        function updateAddress(table, value) {
            if (!scheduleData.sharedAddresses) {
                scheduleData.sharedAddresses = {};
            }
            scheduleData.sharedAddresses[table] = value;
            saveToServer();
            logActivity(`${currentUser} updated address for ${table}`);
        }

        function updateSlot(table, time, value) {
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey].slots) {
                scheduleData[dateKey].slots = {};
            }
            if (!scheduleData[dateKey].slots[table]) {
                scheduleData[dateKey].slots[table] = {};
            }

            scheduleData[dateKey].slots[table][time] = value;
            saveToServer();

            const action = value ? 'set' : 'cleared';
            logActivity(`${currentUser} ${action} ${time} for ${table}`);
        }

        function updateSharedNotes(value) {
            scheduleData.sharedNotes = value;
            saveToServer();
            logActivity(`${currentUser} updated shared notes`);
        }

        function showAddDialog() {
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey]) {
                scheduleData[dateKey] = { tables: [], slots: {} };
            }

            const currentData = scheduleData[dateKey];
            const existingTables = currentData.tables || [];

            document.querySelectorAll('#addDialog .table-option').forEach(option => {
                const tableNum = option.textContent;
                if (existingTables.includes(tableNum)) {
                    option.classList.add('disabled');
                    option.onclick = null;
                } else {
                    option.classList.remove('disabled');
                    option.onclick = () => addTable(tableNum);
                }
            });

            document.getElementById('overlay').classList.add('show');
            document.getElementById('addDialog').classList.add('show');
        }

        function hideAddDialog() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('addDialog').classList.remove('show');
        }

        function addTable(tableNum) {
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey].tables) {
                scheduleData[dateKey].tables = [];
            }

            if (!scheduleData[dateKey].tables.includes(tableNum)) {
                scheduleData[dateKey].tables.push(tableNum);
                scheduleData[dateKey].tables.sort((a, b) => {
                    const aNum = parseInt(a);
                    const bNum = parseInt(b);
                    const aIsNum = !isNaN(aNum);
                    const bIsNum = !isNaN(bNum);

                    if (aIsNum && bIsNum) return aNum - bNum;
                    if (aIsNum && !bIsNum) return -1;
                    if (!aIsNum && bIsNum) return 1;
                    return a.localeCompare(b, 'zh-CN');
                });

                saveToServer();
                renderSchedule();
                logActivity(`${currentUser} added table ${tableNum}`);
            }

            hideAddDialog();
        }

        function showDeleteDialog() {
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey]) {
                scheduleData[dateKey] = { tables: [], slots: {} };
            }

            const existingTables = scheduleData[dateKey].tables || [];

            if (existingTables.length === 0) {
                alert('No tables to delete');
                return;
            }

            const optionsHTML = existingTables.map(table =>
                `<div class="table-option" onclick="deleteTable('${table}')">${table}</div>`
            ).join('');

            document.getElementById('deleteOptions').innerHTML = optionsHTML;
            document.getElementById('overlay').classList.add('show');
            document.getElementById('deleteDialog').classList.add('show');
        }

        function hideDeleteDialog() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('deleteDialog').classList.remove('show');
        }

        function deleteTable(tableNum) {
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (confirm(`Delete table ${tableNum}?`)) {
                const index = scheduleData[dateKey].tables.indexOf(tableNum);
                if (index > -1) {
                    scheduleData[dateKey].tables.splice(index, 1);

                    if (scheduleData[dateKey].slots && scheduleData[dateKey].slots[tableNum]) {
                        delete scheduleData[dateKey].slots[tableNum];
                    }

                    saveToServer();
                    renderSchedule();
                    logActivity(`${currentUser} deleted table ${tableNum}`);
                }
            }

            hideDeleteDialog();
        }

        function toggleActivityLog() {
            document.getElementById('activityLogDialog').classList.toggle('show');
        }

        function logActivity(message) {
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

            activityLog.unshift({ time, message });

            if (activityLog.length > 50) {
                activityLog = activityLog.slice(0, 50);
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('activityLog');
            if (!logContainer) return;

            logContainer.innerHTML = activityLog.map(entry =>
                `<div class="log-entry"><span class="time">[${escapeHtml(entry.time)}]</span> ${escapeHtml(entry.message)}</div>`
            ).join('');
        }

        function showLogoutDialog() {
            document.getElementById('logoutOverlay').classList.add('show');
            document.getElementById('logoutDialog').classList.add('show');
        }

        function hideLogoutDialog() {
            document.getElementById('logoutOverlay').classList.remove('show');
            document.getElementById('logoutDialog').classList.remove('show');
        }

        function confirmLogout() {
            logActivity(`${currentUser} logged out`);
            localStorage.removeItem('currentUser');
            currentUser = null;
            hideLogoutDialog();
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Ticker functions
        function canEditTicker() {
            return currentUser === 'kris' || currentUser === 'lion';
        }

        function updateTickerEditButton() {
            const menuItem = document.getElementById('tickerMenuItem');
            if (menuItem) {
                menuItem.style.display = canEditTicker() ? 'flex' : 'none';
            }
        }

        // Menu functions
        function toggleMenu() {
            const dropdown = document.getElementById('menuDropdown');
            dropdown.classList.toggle('show');
        }

        function closeMenu() {
            const dropdown = document.getElementById('menuDropdown');
            dropdown.classList.remove('show');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menuContainer = document.querySelector('.menu-container');
            if (menuContainer && !menuContainer.contains(e.target)) {
                closeMenu();
            }
        });

        function updateTickerDisplay() {
            const tickerEl = document.getElementById('tickerText');
            if (tickerEl && scheduleData.tickerText) {
                tickerEl.textContent = scheduleData.tickerText;
            } else if (tickerEl) {
                tickerEl.textContent = '';
            }
        }

        function showTickerDialog() {
            if (!canEditTicker()) return;
            document.getElementById('tickerInput').value = scheduleData.tickerText || '';
            document.getElementById('overlay').classList.add('show');
            document.getElementById('tickerDialog').classList.add('show');
            document.getElementById('tickerInput').focus();
        }

        function hideTickerDialog() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('tickerDialog').classList.remove('show');
        }

        function saveTickerText() {
            const newText = document.getElementById('tickerInput').value;
            scheduleData.tickerText = newText;
            saveToServer();
            updateTickerDisplay();
            hideTickerDialog();
            logActivity(`${currentUser} updated ticker text`);
        }

        // YouTube Music Player
        let ytPlayer = null;
        let isPlaying = false;
        let playerReady = false;
        let apiLoaded = false;
        let playlist = [];
        let currentTrackIndex = -1;

        // Load YouTube IFrame API
        function loadYouTubeAPI() {
            if (apiLoaded) return;
            apiLoaded = true;
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            document.head.appendChild(tag);
        }

        window.onYouTubeIframeAPIReady = function() {
            playerReady = false;
            console.log('YouTube API ready');
        };

        function createPlayerForVideo(videoId) {
            if (ytPlayer) {
                ytPlayer.destroy();
            }
            ytPlayer = new YT.Player('youtubePlayer', {
                height: '1',
                width: '1',
                videoId: videoId,
                playerVars: {
                    autoplay: 1,
                    controls: 0,
                    modestbranding: 1,
                    playsinline: 1,
                    enablejsapi: 1
                },
                events: {
                    onReady: (e) => { playerReady = true; e.target.setVolume(70); e.target.playVideo(); },
                    onStateChange: onPlayerStateChange,
                    onError: () => nextTrack()
                }
            });
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                isPlaying = true;
                updateMusicUI();
            } else if (event.data === YT.PlayerState.PAUSED) {
                isPlaying = false;
                updateMusicUI();
            } else if (event.data === YT.PlayerState.ENDED) {
                nextTrack();
            }
        }

        function toggleMusic() {
            document.getElementById('musicModal').classList.add('show');
            if (playlist.length === 0) loadPlaylist();
        }

        function closeMusicModal() {
            document.getElementById('musicModal').classList.remove('show');
        }

        async function loadPlaylist() {
            try {
                const res = await fetch(`${API_BASE}/api/playlist`);
                const data = await res.json();
                if (data.tracks) {
                    playlist = data.tracks;
                    renderPlaylist();
                }
            } catch (e) {
                document.getElementById('playlistContainer').innerHTML = '<div class="playlist-loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        function renderPlaylist() {
            const container = document.getElementById('playlistContainer');
            if (playlist.length === 0) {
                container.innerHTML = '<div class="playlist-loading">–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç</div>';
                return;
            }
            container.innerHTML = playlist.map((track, i) => `
                <div class="playlist-item ${i === currentTrackIndex ? 'active' : ''}" onclick="playTrack(${i})">
                    <img class="playlist-thumb" src="${track.thumbnail}" alt="">
                    <div class="playlist-info">
                        <div class="playlist-item-title">${escapeHtml(track.title)}</div>
                        <div class="playlist-item-artist">${escapeHtml(track.channel)}</div>
                    </div>
                </div>
            `).join('');
        }

        function playTrack(index) {
            if (!window.YT) { loadYouTubeAPI(); setTimeout(() => playTrack(index), 1000); return; }
            currentTrackIndex = index;
            const track = playlist[index];
            document.getElementById('nowPlayingTitle').textContent = track.title;
            document.getElementById('nowPlayingArtist').textContent = track.channel;
            createPlayerForVideo(track.id);
            renderPlaylist();
        }

        function togglePlayPause() {
            if (!ytPlayer) { if (playlist.length > 0) playTrack(0); return; }
            if (isPlaying) ytPlayer.pauseVideo(); else ytPlayer.playVideo();
        }

        function prevTrack() {
            if (playlist.length === 0) return;
            currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            playTrack(currentTrackIndex);
        }

        function nextTrack() {
            if (playlist.length === 0) return;
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            playTrack(currentTrackIndex);
        }

        function updateMusicUI() {
            const btn = document.getElementById('playPauseBtn');
            if (btn) btn.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
            const headerBtn = document.getElementById('musicBtn');
            if (headerBtn) {
                headerBtn.style.background = isPlaying ? 'linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.3))' : '';
            }
        }

        function updateMusicButton() { updateMusicUI(); }

        loadYouTubeAPI();

        // Weather for Shanghai
        const SHANGHAI_LAT = 31.2304;
        const SHANGHAI_LON = 121.4737;

        function getWeatherIcon(code, isDay) {
            // WMO Weather codes mapping
            const icons = {
                0: isDay ? '‚òÄÔ∏è' : 'üåô',   // Clear sky
                1: isDay ? 'üå§Ô∏è' : 'üåô',   // Mainly clear
                2: '‚õÖ',                   // Partly cloudy
                3: '‚òÅÔ∏è',                   // Overcast
                45: 'üå´Ô∏è', 48: 'üå´Ô∏è',       // Fog
                51: 'üåßÔ∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è', // Drizzle
                56: 'üåßÔ∏è', 57: 'üåßÔ∏è',       // Freezing drizzle
                61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è', // Rain
                66: 'üåßÔ∏è', 67: 'üåßÔ∏è',       // Freezing rain
                71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è', // Snow
                77: 'üå®Ô∏è',                 // Snow grains
                80: 'üåßÔ∏è', 81: 'üåßÔ∏è', 82: 'üåßÔ∏è', // Rain showers
                85: 'üå®Ô∏è', 86: 'üå®Ô∏è',       // Snow showers
                95: '‚õàÔ∏è',                 // Thunderstorm
                96: '‚õàÔ∏è', 99: '‚õàÔ∏è'        // Thunderstorm with hail
            };
            return icons[code] || 'üå°Ô∏è';
        }

        async function fetchWeather() {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${SHANGHAI_LAT}&longitude=${SHANGHAI_LON}&current=temperature_2m,weather_code,precipitation,is_day&timezone=Asia/Shanghai`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.current) {
                    const temp = Math.round(data.current.temperature_2m);
                    const weatherCode = data.current.weather_code;
                    const precipitation = data.current.precipitation;
                    const isDay = data.current.is_day === 1;

                    document.getElementById('weatherIcon').textContent = getWeatherIcon(weatherCode, isDay);
                    document.getElementById('weatherTemp').textContent = `${temp}¬∞`;

                    const precipEl = document.getElementById('weatherPrecip');
                    if (precipitation > 0) {
                        precipEl.innerHTML = `üíß${precipitation}mm`;
                    } else {
                        precipEl.textContent = '';
                    }
                }
            } catch (error) {
                console.error('Weather fetch failed:', error);
            }
        }

        // Fetch weather on load and every 10 minutes
        fetchWeather();
        setInterval(fetchWeather, 600000);
    </script>
</body>
</html>