<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shanghai Schedule</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #000;
        }

        .login-box {
            background: #111;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
        }

        .login-title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #fff;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            font-size: 16px;
            border-radius: 5px;
        }

        .login-button {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: #333;
            border: none;
            color: #fff;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .login-button:active {
            background: #444;
        }

        .error-msg {
            color: #ff4444;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
            background: #000;
        }

        /* Header */
        .header {
            background: #000;
            padding: 10px;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .time-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .time-display-inner {
            font-size: 32px;
        }

        .header-btn {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .header-btn:active {
            background: #333;
            transform: scale(0.95);
        }

        .date-display {
            text-align: center;
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }

        /* Date Navigation */
        .date-tabs {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }

        .date-tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: #888;
            border: none;
            background: transparent;
            font-size: 14px;
            cursor: pointer;
        }

        .date-tab.active {
            color: #fff;
            border-bottom: 2px solid #fff;
        }

        /* Schedule Container */
        .schedule-container {
            padding: 0;
        }

        /* Schedule Grid */
        .schedule-grid {
            display: table;
            width: 100%;
            border-collapse: collapse;
        }

        .schedule-row {
            display: table-row;
            border-bottom: 1px solid #222;
        }

        .schedule-cell {
            display: table-cell;
            padding: 8px;
            border-right: 1px solid #222;
            vertical-align: middle;
            text-align: center;
            position: relative;
        }

        .schedule-cell:last-child {
            border-right: none;
        }

        /* Table Headers */
        .table-header {
            background: #111;
            position: sticky;
            top: 0;
        }

        .table-header .schedule-cell {
            font-weight: bold;
            font-size: 18px;
            padding: 12px 8px;
            color: #fff;
        }

        /* Time Column */
        .time-cell {
            background: #0a0a0a;
            font-size: 13px;
            color: #888;
            width: 60px;
            font-weight: 500;
        }

        /* Data Cells */
        .data-cell {
            min-height: 40px;
            position: relative;
            cursor: pointer;
            background: #000;
        }

        .data-cell:active {
            background: #111;
        }

        /* Input Fields */
        .cell-input {
            width: 100%;
            height: 100%;
            min-height: 40px;
            background: transparent;
            border: none;
            color: #fff;
            text-align: center;
            font-size: 14px;
            padding: 5px;
        }

        .cell-input:focus {
            outline: 1px solid #444;
            background: #111;
        }

        /* Chinese Address Row */
        .address-row {
            background: #0a0a0a;
        }

        .address-row .data-cell {
            font-size: 12px;
            color: #888;
        }

        .address-input {
            width: 100%;
            background: transparent;
            border: none;
            color: #888;
            text-align: center;
            font-size: 12px;
            padding: 8px 2px;
        }

        .address-input:focus {
            outline: 1px solid #333;
            background: #111;
            color: #fff;
        }

        /* Special Markers */
        .red-x {
            color: #ff0000;
            font-size: 24px;
            font-weight: bold;
        }

        .green-check {
            color: #00ff00;
            font-size: 20px;
        }

        .yellow-marker {
            background: rgba(255, 255, 0, 0.1);
        }

        /* Status Indicators */
        .with-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .icon {
            font-size: 16px;
        }

        .soccer-icon::after {
            content: '‚öΩ';
        }

        .time-icon::after {
            content: 'üïê';
        }

        /* Activity Log Button */
        .log-button {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }

        .log-button:active {
            background: #333;
            transform: scale(0.95);
        }

        /* Activity Log Dialog */
        .activity-log-dialog {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 60vh;
            background: #0a0a0a;
            border-top: 2px solid #333;
            padding: 15px;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 95;
        }

        .activity-log-dialog.show {
            transform: translateY(0);
        }

        .activity-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222;
        }

        .activity-log-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-log-btn {
            background: #333;
            border: none;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .log-entry {
            font-size: 13px;
            color: #ddd;
            margin: 8px 0;
            padding: 8px 12px;
            background: #111;
            border-left: 3px solid #4CAF50;
            border-radius: 4px;
            line-height: 1.4;
        }

        .log-entry .time {
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
        }

        /* Add table dialog */
        .add-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #111;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
            display: none;
            z-index: 200;
        }

        .add-dialog.show {
            display: block;
        }

        .dialog-title {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .table-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .table-option {
            padding: 15px;
            background: #222;
            border: 1px solid #444;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

        .table-option:active {
            background: #333;
        }

        .table-option.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .close-dialog {
            width: 100%;
            padding: 10px;
            background: #333;
            border: none;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 150;
        }

        .overlay.show {
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .schedule-cell {
                font-size: 12px;
                padding: 4px;
            }
            
            .table-header .schedule-cell {
                font-size: 14px;
            }
            
            .time-cell {
                font-size: 11px;
                width: 45px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">‰∏äÊµ∑ÊéíÁè≠Á≥ªÁªü</h1>
            <input type="text" class="login-input" id="username" placeholder="Áî®Êà∑Âêç">
            <input type="password" class="login-input" id="password" placeholder="ÂØÜÁ†Å">
            <button class="login-button" onclick="login()">ÁôªÂΩï</button>
            <div class="error-msg" id="errorMsg"></div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="header">
            <div class="time-display">
                <button class="header-btn" onclick="showDeleteDialog()" title="–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü">-</button>
                <span class="time-display-inner" id="timeDisplay">13:18</span>
                <button class="header-btn" onclick="showAddDialog()" title="–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü">+</button>
                <button class="header-btn" onclick="toggleActivityLog()" title="–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π">üìã</button>
            </div>
            <div class="date-display" id="dateDisplay">4 –Ω–æ—è–±—Ä—è 2025–≥. –≤ 12:39 ‚Äî –æ–±—â–∞—è</div>
        </div>

        <!-- Date Tabs -->
        <div class="date-tabs">
            <button class="date-tab active" onclick="switchDate(0)" id="tab0">4.11</button>
            <button class="date-tab" onclick="switchDate(1)" id="tab1">5.11</button>
            <button class="date-tab" onclick="switchDate(2)" id="tab2">6.11</button>
        </div>

        <!-- Schedule Container -->
        <div class="schedule-container" id="scheduleContainer"></div>

        <!-- Add Table Dialog -->
        <div class="overlay" id="overlay" onclick="hideAddDialog()"></div>
        <div class="add-dialog" id="addDialog">
            <h3 class="dialog-title">ÈÄâÊã©Ê°åÂè∞Âè∑</h3>
            <div class="table-options">
                <div class="table-option" onclick="addTable('111')">111</div>
                <div class="table-option" onclick="addTable('222')">222</div>
                <div class="table-option" onclick="addTable('333')">333</div>
                <div class="table-option" onclick="addTable('555')">555</div>
                <div class="table-option" onclick="addTable('666')">666</div>
                <div class="table-option" onclick="addTable('888')">888</div>
            </div>
            <button class="close-dialog" onclick="hideAddDialog()">ÂèñÊ∂à</button>
        </div>

        <!-- Delete Table Dialog -->
        <div class="add-dialog" id="deleteDialog">
            <h3 class="dialog-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <div class="table-options" id="deleteOptions"></div>
            <button class="close-dialog" onclick="hideDeleteDialog()">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <!-- Activity Log Dialog -->
        <div class="activity-log-dialog" id="activityLogDialog">
            <div class="activity-log-header">
                <div class="activity-log-title">üìã –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</div>
                <button class="close-log-btn" onclick="toggleActivityLog()">√ó</button>
            </div>
            <div id="activityLog"></div>
        </div>
    </div>

    <script>
        // Configuration
        const USERS = {
            'kris': '12344321',
            'misha': '12344321',
            'katya': '12344321',
            'wang': '12344321',
            'lion': '12344321'
        };

        const TIME_SLOTS = [
            '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
            '18:00', '19:00', '20:00', '21:00', '22:00', '23:00',
            '00:00', '01:00', '02:00'
        ];

        // API base URL
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : window.location.origin;

        // State
        let currentUser = null;
        let currentDate = 0;
        let scheduleData = {};
        let activityLog = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkSavedLogin();
            initializeData();
            startClock();
            loadFromServer();

            // Enter key support
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });

            // Start auto-refresh
            startAutoRefresh();
        });

        function initializeData() {
            const dates = getNextThreeDates();
            dates.forEach(date => {
                if (!scheduleData[date.key]) {
                    scheduleData[date.key] = {
                        tables: []
                    };
                }
            });
        }

        function loadDemoData() {
            const dates = getNextThreeDates();
            
            // Demo data for first day
            scheduleData[dates[0].key] = {
                tables: ['111', '333', '555']
            };
            
            // Set demo slot data
            if (!scheduleData[dates[0].key].slots) {
                scheduleData[dates[0].key].slots = {};
            }
            
            // Table 111 data
            scheduleData[dates[0].key].slots['111'] = {
                address: 'Êñ∞ÈóªË∑Ø‰∏éÈïøÊ≤ôË∑Ø‰∫§Ê±áÂ§Ñ (Êñ∞ÈóªË∑Ø126Âè∑)',
                '12:00': '‚úì',
                '13:00': '',
                '14:00': '',
                '15:00': '',
                '16:00': '',
                '17:00': '',
                '18:00': '',
                '19:00': '',
                '20:00': '‚öΩ',
                '21:00': '',
                '22:00': '',
                '23:00': '',
                '00:00': '',
                '01:00': '‚öΩ',
                '02:00': ''
            };
            
            // Table 333 data
            scheduleData[dates[0].key].slots['333'] = {
                address: 'Ë∑ùÈπøË∑Ø242Ëôü',
                '12:00': '',
                '13:00': '',
                '14:00': '',
                '15:00': '',
                '16:00': '',
                '17:00': '',
                '18:00': '‚öΩ',
                '19:00': '',
                '20:00': '',
                '21:00': '',
                '22:00': '',
                '23:00': '',
                '00:00': '',
                '01:00': '',
                '02:00': ''
            };
            
            // Table 555 data
            scheduleData[dates[0].key].slots['555'] = {
                address: 'È∫óÂúíË∑Ø708Ëôü',
                '12:00': '',
                '13:00': '',
                '14:00': '',
                '15:00': '',
                '16:00': '',
                '17:00': '',
                '18:00': '',
                '19:00': '7:30 üïê',
                '20:00': '',
                '21:00': '',
                '22:00': '',
                '23:00': '',
                '00:00': '',
                '01:00': '',
                '02:00': ''
            };

            // Second day - one table
            scheduleData[dates[1].key] = {
                tables: ['111'],
                slots: {
                    '111': {
                        address: '',
                        '12:00': '‚ùå',
                        '13:00': '',
                        '14:00': '',
                        '15:00': '',
                        '16:00': '',
                        '17:00': '',
                        '18:00': '',
                        '19:00': '',
                        '20:00': '',
                        '21:00': '',
                        '22:00': '',
                        '23:00': '',
                        '00:00': '',
                        '01:00': '',
                        '02:00': ''
                    }
                }
            };
        }

        function getNextThreeDates() {
            const dates = [];
            // Use Shanghai time
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));

            for (let i = 0; i < 3; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() + i);

                const month = date.getMonth() + 1;
                const day = date.getDate();

                dates.push({
                    key: `${date.getFullYear()}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
                    display: `${day}.${month}`
                });
            }

            return dates;
        }

        function startClock() {
            updateClock();
            setInterval(updateClock, 1000);
        }

        function updateClock() {
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            if (document.getElementById('timeDisplay')) {
                document.getElementById('timeDisplay').textContent = `${hours}:${minutes}`;
            }
        }

        function checkSavedLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && USERS[savedUser]) {
                currentUser = savedUser;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateDateDisplay();
                renderSchedule();
            }
        }

        function login() {
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;

            if (USERS[username] && USERS[username] === password) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateDateDisplay();
                renderSchedule();
                logActivity(`${username} –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É`);
            } else {
                document.getElementById('errorMsg').textContent = 'Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ';
                setTimeout(() => {
                    document.getElementById('errorMsg').textContent = '';
                }, 3000);
            }
        }

        // Load data from server
        async function loadFromServer() {
            try {
                const response = await fetch(`${API_BASE}/api/schedule`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.scheduleData && Object.keys(data.scheduleData).length > 0) {
                        scheduleData = data.scheduleData;
                        activityLog = data.activityLog || [];
                        renderSchedule();
                        updateLogDisplay();
                    } else {
                        // Load demo data if server has no data
                        loadDemoData();
                        saveToServer();
                    }
                }
            } catch (error) {
                console.error('Failed to load from server:', error);
                // Try loading from localStorage as fallback
                const saved = localStorage.getItem('scheduleData');
                if (saved) {
                    scheduleData = JSON.parse(saved);
                    renderSchedule();
                } else {
                    loadDemoData();
                }
            }
        }

        // Save data to server
        async function saveToServer() {
            try {
                console.log('üì§ Saving data to server...', {
                    tables: Object.keys(scheduleData).length,
                    logs: activityLog.length
                });

                const response = await fetch(`${API_BASE}/api/schedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scheduleData,
                        activityLog
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Data saved to server successfully');
                } else {
                    console.error('‚ùå Server responded with error:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Failed to save to server:', error);
            }
        }

        // Auto-refresh from server
        function startAutoRefresh() {
            setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/schedule`);
                    if (response.ok) {
                        const data = await response.json();
                        if (JSON.stringify(data.scheduleData) !== JSON.stringify(scheduleData)) {
                            console.log('üì• Syncing data from server');
                            scheduleData = data.scheduleData;
                            activityLog = data.activityLog || [];

                            // Also update localStorage to keep in sync
                            saveToLocalStorage();

                            renderSchedule();
                            updateLogDisplay();
                        }
                    }
                } catch (error) {
                    console.error('Auto-refresh failed:', error);
                }
            }, 2000);
        }

        function updateDateDisplay() {
            const dates = getNextThreeDates();
            document.getElementById('tab0').textContent = dates[0].display;
            document.getElementById('tab1').textContent = dates[1].display;
            document.getElementById('tab2').textContent = dates[2].display;

            // Use Shanghai time
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
            const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
                          '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
            const dateStr = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}–≥. –≤ ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')} ‚Äî –æ–±—â–∞—è`;
            document.getElementById('dateDisplay').textContent = dateStr;
        }

        function switchDate(index) {
            currentDate = index;
            
            // Update active tab
            document.querySelectorAll('.date-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab${index}`).classList.add('active');
            
            renderSchedule();
        }

        function renderSchedule() {
            const container = document.getElementById('scheduleContainer');
            if (!container) {
                console.error('Schedule container not found');
                return;
            }

            const dates = getNextThreeDates();
            const dateKey = dates[currentDate].key;

            // Ensure data exists for current date
            if (!scheduleData[dateKey]) {
                console.log(`Creating empty data for ${dateKey}`);
                scheduleData[dateKey] = {
                    tables: [],
                    slots: {}
                };
            }

            const currentData = scheduleData[dateKey];
            const tables = currentData.tables || [];

            console.log(`Rendering schedule for ${dateKey}:`, {
                tables: tables,
                hasSlots: !!currentData.slots
            });

            let html = '<div class="schedule-grid">';
            
            // Header row
            html += '<div class="schedule-row table-header">';
            html += '<div class="schedule-cell time-cell"></div>';
            tables.forEach(table => {
                html += `<div class="schedule-cell">${table}</div>`;
            });
            html += '</div>';
            
            // Address row
            html += '<div class="schedule-row address-row">';
            html += '<div class="schedule-cell time-cell"></div>';
            tables.forEach(table => {
                const address = currentData.slots?.[table]?.address || '';
                html += `<div class="schedule-cell data-cell">
                    <input type="text" class="address-input" 
                        placeholder="Âú∞ÂùÄ" 
                        value="${address}"
                        onchange="updateAddress('${table}', this.value)">
                </div>`;
            });
            html += '</div>';
            
            // Time slots
            TIME_SLOTS.forEach(time => {
                html += '<div class="schedule-row">';
                html += `<div class="schedule-cell time-cell">${time}</div>`;
                
                tables.forEach(table => {
                    const value = currentData.slots?.[table]?.[time] || '';
                    const isSpecial = value.includes('‚ùå') || value.includes('‚öΩ') || value.includes('‚úì');
                    
                    html += `<div class="schedule-cell data-cell">
                        <input type="text" class="cell-input ${isSpecial ? 'with-icon' : ''}" 
                            value="${value}"
                            onchange="updateSlot('${table}', '${time}', this.value)"
                            onfocus="this.select()">
                    </div>`;
                });
                
                html += '</div>';
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function updateAddress(table, value) {
            const dates = getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey].slots) {
                scheduleData[dateKey].slots = {};
            }
            if (!scheduleData[dateKey].slots[table]) {
                scheduleData[dateKey].slots[table] = {};
            }

            scheduleData[dateKey].slots[table].address = value;
            saveToLocalStorage();
            saveToServer();
            logActivity(`${currentUser} –æ–±–Ω–æ–≤–∏–ª –∞–¥—Ä–µ—Å —Å—Ç–æ–ª–∞ ${table}`);
        }

        function updateSlot(table, time, value) {
            const dates = getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey].slots) {
                scheduleData[dateKey].slots = {};
            }
            if (!scheduleData[dateKey].slots[table]) {
                scheduleData[dateKey].slots[table] = {};
            }

            scheduleData[dateKey].slots[table][time] = value;
            saveToLocalStorage();
            saveToServer();

            const action = value ? '–∑–∞–ø–∏—Å–∞–ª' : '–æ—á–∏—Å—Ç–∏–ª';
            logActivity(`${currentUser} ${action} ${time} –¥–ª—è —Å—Ç–æ–ª–∞ ${table}`);
        }

        function showAddDialog() {
            const dates = getNextThreeDates();
            const dateKey = dates[currentDate].key;

            // Ensure data exists
            if (!scheduleData[dateKey]) {
                scheduleData[dateKey] = { tables: [], slots: {} };
            }

            const currentData = scheduleData[dateKey];
            const existingTables = currentData.tables || [];
            
            // Update available options
            document.querySelectorAll('.table-option').forEach(option => {
                const tableNum = option.textContent;
                if (existingTables.includes(tableNum)) {
                    option.classList.add('disabled');
                    option.onclick = null;
                } else {
                    option.classList.remove('disabled');
                    option.onclick = () => addTable(tableNum);
                }
            });
            
            document.getElementById('overlay').classList.add('show');
            document.getElementById('addDialog').classList.add('show');
        }

        function hideAddDialog() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('addDialog').classList.remove('show');
        }

        function addTable(tableNum) {
            const dates = getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey].tables) {
                scheduleData[dateKey].tables = [];
            }

            if (!scheduleData[dateKey].tables.includes(tableNum)) {
                scheduleData[dateKey].tables.push(tableNum);
                scheduleData[dateKey].tables.sort((a, b) => parseInt(a) - parseInt(b));

                saveToLocalStorage();
                saveToServer();
                renderSchedule();
                logActivity(`${currentUser} –¥–æ–±–∞–≤–∏–ª —Å—Ç–æ–ª ${tableNum}`);
            }

            hideAddDialog();
        }

        function saveData() {
            saveToLocalStorage();
            saveToServer();
            alert('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            logActivity(`${currentUser} —Å–æ—Ö—Ä–∞–Ω–∏–ª –¥–∞–Ω–Ω—ã–µ`);
        }

        function saveToLocalStorage() {
            localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
        }

        function toggleLog() {
            const log = document.getElementById('activityLog');
            log.classList.toggle('show');
        }

        function toggleActivityLog() {
            const dialog = document.getElementById('activityLogDialog');
            dialog.classList.toggle('show');
        }

        function logActivity(message) {
            // Use Shanghai time
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

            activityLog.unshift({
                time: time,
                message: message
            });

            if (activityLog.length > 50) {
                activityLog = activityLog.slice(0, 50);
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('activityLog');
            logContainer.innerHTML = activityLog.map(entry => 
                `<div class="log-entry"><span class="time">[${entry.time}]</span> ${entry.message}</div>`
            ).join('');
        }

        async function captureScreen() {
            try {
                // Load html2canvas if not already loaded
                if (!window.html2canvas) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                }

                // Capture the schedule container
                const element = document.getElementById('appContainer');
                const canvas = await html2canvas(element, {
                    backgroundColor: '#000',
                    scale: 2,
                    logging: false
                });

                // Convert to blob
                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('screenshot', blob, 'schedule.jpg');
                    formData.append('user', currentUser);

                    try {
                        const response = await fetch(`${API_BASE}/api/screenshot`, {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            alert('‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram');
                            logActivity(`${currentUser} –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–∫—Ä–∏–Ω—à–æ—Ç`);
                        } else {
                            alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç');
                        }
                    } catch (error) {
                        console.error('Screenshot upload failed:', error);
                        alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞');
                    }
                }, 'image/jpeg', 0.9);

            } catch (error) {
                console.error('Screenshot capture failed:', error);
                alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç');
            }
        }

        // Note: Auto-refresh is handled by startAutoRefresh() function
        // which syncs from server every 2 seconds

        // Delete dialog functions
        function showDeleteDialog() {
            const dates = getNextThreeDates();
            const dateKey = dates[currentDate].key;

            // Ensure data exists
            if (!scheduleData[dateKey]) {
                scheduleData[dateKey] = { tables: [], slots: {} };
            }

            const currentData = scheduleData[dateKey];
            const existingTables = currentData.tables || [];
            
            if (existingTables.length === 0) {
                alert('–ù–µ—Ç —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            const optionsHTML = existingTables.map(table => 
                `<div class="table-option" onclick="deleteTable('${table}')">${table}</div>`
            ).join('');
            
            document.getElementById('deleteOptions').innerHTML = optionsHTML;
            document.getElementById('overlay').classList.add('show');
            document.getElementById('deleteDialog').classList.add('show');
        }

        function hideDeleteDialog() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('deleteDialog').classList.remove('show');
        }

        function deleteTable(tableNum) {
            const dates = getNextThreeDates();
            const dateKey = dates[currentDate].key;
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü ${tableNum}?`)) {
                const index = scheduleData[dateKey].tables.indexOf(tableNum);
                if (index > -1) {
                    scheduleData[dateKey].tables.splice(index, 1);
                    
                    if (scheduleData[dateKey].slots && scheduleData[dateKey].slots[tableNum]) {
                        delete scheduleData[dateKey].slots[tableNum];
                    }
                    
                    saveToLocalStorage();
                    saveToServer();
                    renderSchedule();
                    logActivity(`${currentUser} —É–¥–∞–ª–∏–ª —Å—Ç–æ–ª ${tableNum}`);
                }
            }
            
            hideDeleteDialog();
        }

        // Auto-screenshot for /all command
        setInterval(async () => {
            try {
                const response = await fetch(`${API_BASE}/api/trigger-screenshot`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.pending) {
                        console.log('Auto-capturing screenshot for /all command...');
                        await captureScreen();
                    }
                }
            } catch (error) {
                console.error('Screenshot trigger check failed:', error);
            }
        }, 3000);
    </script>
</body>
</html>
