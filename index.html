<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shanghai Schedule</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(at 40% 20%, hsla(280,100%,74%,0.1) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189,100%,56%,0.1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(355,100%,93%,0.1) 0px, transparent 50%);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: inherit;
        }

        .login-box {
            background: rgba(17, 17, 17, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .login-title {
            text-align: center;
            font-size: 28px;
            margin-bottom: 30px;
            color: #fff;
            font-weight: 600;
            background: linear-gradient(to right, #a78bfa, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: rgba(167, 139, 250, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .login-button {
            width: 100%;
            padding: 14px;
            margin-top: 20px;
            background: linear-gradient(135deg, #7c3aed, #2563eb);
            border: none;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(124, 58, 237, 0.4);
        }

        .login-button:active {
            transform: translateY(0);
        }

        .error-msg {
            color: #ff4444;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
            background: transparent;
        }

        /* Header */
        .header {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
        }

        .time-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .time-display-inner {
            font-size: 32px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .header-btn:active {
            transform: scale(0.95) translateY(0);
        }


        .date-display {
            text-align: center;
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }

        /* Date Navigation */
        .date-tabs {
            display: flex;
            justify-content: space-around;
            padding: 15px 10px;
            background: rgba(17, 17, 17, 0.5);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .date-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: #888;
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .date-tab.active {
            color: #fff;
        }

        .date-tab.active::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 20%;
            right: 20%;
            height: 3px;
            background: linear-gradient(to right, #a78bfa, #60a5fa);
            border-radius: 2px;
        }

        /* Schedule Container */
        .schedule-container {
            padding: 0;
        }

        /* Schedule Grid */
        .schedule-grid {
            display: table;
            width: 100%;
            border-collapse: collapse;
            margin-top: 1px;
        }

        .schedule-row {
            display: table-row;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s;
        }

        .schedule-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .schedule-cell {
            display: table-cell;
            padding: 8px;
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            vertical-align: middle;
            text-align: center;
            position: relative;
        }

        .schedule-cell:last-child {
            border-right: none;
        }

        /* Table Headers */
        .table-header {
            background: rgba(17, 17, 17, 0.9);
            backdrop-filter: blur(5px);
            position: sticky;
            top: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-header .schedule-cell {
            font-weight: 600;
            font-size: 18px;
            padding: 14px 8px;
            color: #fff;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(37, 99, 235, 0.1));
        }

        /* Time Column */
        .time-cell {
            background: #0a0a0a;
            font-size: 13px;
            color: #888;
            width: 60px;
            font-weight: 500;
        }

        /* Data Cells */
        .data-cell {
            min-height: 45px;
            position: relative;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .data-cell:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .data-cell:active {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Input Fields */
        .cell-input {
            width: 100%;
            height: 100%;
            min-height: 45px;
            background: transparent;
            border: none;
            color: #fff;
            text-align: center;
            font-size: 14px;
            padding: 5px;
            transition: all 0.2s;
        }

        .cell-input:focus {
            outline: none;
            background: rgba(167, 139, 250, 0.1);
            box-shadow: inset 0 0 0 1px rgba(167, 139, 250, 0.3);
        }

        /* Chinese Address Row */
        .address-row {
            background: #0a0a0a;
        }

        .address-row .data-cell {
            font-size: 12px;
            color: #888;
        }

        .address-input {
            width: 100%;
            background: transparent;
            border: none;
            color: #999;
            text-align: center;
            font-size: 12px;
            padding: 10px 4px;
            transition: all 0.2s;
        }

        .address-input:focus {
            outline: none;
            background: rgba(167, 139, 250, 0.08);
            color: #fff;
            box-shadow: inset 0 0 0 1px rgba(167, 139, 250, 0.2);
        }

        /* Special Markers */
        .red-x {
            color: #ff0000;
            font-size: 24px;
            font-weight: bold;
        }

        .green-check {
            color: #00ff00;
            font-size: 20px;
        }

        .yellow-marker {
            background: rgba(255, 255, 0, 0.1);
        }

        /* Status Indicators */
        .with-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .icon {
            font-size: 16px;
        }

        .soccer-icon::after {
            content: '‚öΩ';
        }

        .time-icon::after {
            content: 'üïê';
        }

        /* Activity Log Button */
        .log-button {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }

        .log-button:active {
            background: #333;
            transform: scale(0.95);
        }

        /* Activity Log Dialog */
        .activity-log-dialog {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 60vh;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-top: 2px solid rgba(167, 139, 250, 0.3);
            padding: 20px;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 95;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
        }

        .activity-log-dialog.show {
            transform: translateY(0);
        }

        .activity-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222;
        }

        .activity-log-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-log-btn {
            background: #333;
            border: none;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .log-entry {
            font-size: 13px;
            color: #ddd;
            margin: 10px 0;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #4CAF50;
            border-radius: 8px;
            line-height: 1.5;
            transition: all 0.2s;
        }

        .log-entry:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(2px);
        }

        .log-entry .time {
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
        }

        /* Add table dialog */
        .add-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            display: none;
            z-index: 200;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        }

        .add-dialog.show {
            display: block;
        }

        .dialog-title {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .table-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .table-option {
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .table-option:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(167, 139, 250, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .table-option:active {
            transform: translateY(0);
        }

        .table-option.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .close-dialog {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .close-dialog:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 150;
        }

        .overlay.show {
            display: block;
        }

        /* Permanent Notes Section */
        .permanent-notes-section {
            padding: 25px 20px;
            background: rgba(17, 17, 17, 0.6);
            backdrop-filter: blur(5px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
        }

        .notes-label {
            font-size: 14px;
            color: #4CAF50;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notes-input {
            width: 100%;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            padding: 16px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
            -webkit-user-select: text;
            user-select: text;
            transition: all 0.3s;
        }

        .notes-input:focus {
            outline: none;
            border-color: rgba(76, 175, 80, 0.5);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .notes-input::placeholder {
            color: #555;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .schedule-cell {
                font-size: 12px;
                padding: 4px;
            }

            .table-header .schedule-cell {
                font-size: 14px;
            }

            .time-cell {
                font-size: 11px;
                width: 45px;
            }

            .permanent-notes-section {
                padding: 15px;
            }

            .notes-input {
                font-size: 13px;
                min-height: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">‰∏äÊµ∑ÊéíÁè≠Á≥ªÁªü</h1>
            <input type="text" class="login-input" id="username" placeholder="Áî®Êà∑Âêç">
            <input type="password" class="login-input" id="password" placeholder="ÂØÜÁ†Å">
            <button class="login-button" onclick="login()">ÁôªÂΩï</button>
            <div class="error-msg" id="errorMsg"></div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="header">
            <div class="time-display">
                <button class="header-btn" onclick="showDeleteDialog()" title="–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü">-</button>
                <span class="time-display-inner" id="timeDisplay">13:18</span>
                <button class="header-btn" onclick="showAddDialog()" title="–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü">+</button>
                <button class="header-btn" onclick="toggleActivityLog()" title="–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π">üìã</button>
            </div>
            <div class="date-display" id="dateDisplay">4 –Ω–æ—è–±—Ä—è 2025–≥. –≤ 12:39 ‚Äî –æ–±—â–∞—è</div>
        </div>

        <!-- Date Tabs -->
        <div class="date-tabs">
            <button class="date-tab active" onclick="switchDate(0)" id="tab0">4.11</button>
            <button class="date-tab" onclick="switchDate(1)" id="tab1">5.11</button>
            <button class="date-tab" onclick="switchDate(2)" id="tab2">6.11</button>
        </div>

        <!-- Schedule Container -->
        <div class="schedule-container" id="scheduleContainer"></div>

        <!-- Add Table Dialog -->
        <div class="overlay" id="overlay" onclick="hideAddDialog()"></div>
        <div class="add-dialog" id="addDialog">
            <h3 class="dialog-title">ÈÄâÊã©Ê°åÂè∞Âè∑</h3>
            <div class="table-options">
                <div class="table-option" onclick="addTable('000')">000</div>
                <div class="table-option" onclick="addTable('111')">111</div>
                <div class="table-option" onclick="addTable('222')">222</div>
                <div class="table-option" onclick="addTable('333')">333</div>
                <div class="table-option" onclick="addTable('555')">555</div>
                <div class="table-option" onclick="addTable('666')">666</div>
                <div class="table-option" onclick="addTable('888')">888</div>
                <div class="table-option" onclick="addTable('999')">999</div>
                <div class="table-option" onclick="addTable('Âåó‰∫¨1')">Âåó‰∫¨1</div>
                <div class="table-option" onclick="addTable('Âåó‰∫¨2')">Âåó‰∫¨2</div>
            </div>
            <button class="close-dialog" onclick="hideAddDialog()">ÂèñÊ∂à</button>
        </div>

        <!-- Delete Table Dialog -->
        <div class="add-dialog" id="deleteDialog">
            <h3 class="dialog-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <div class="table-options" id="deleteOptions"></div>
            <button class="close-dialog" onclick="hideDeleteDialog()">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <!-- Activity Log Dialog -->
        <div class="activity-log-dialog" id="activityLogDialog">
            <div class="activity-log-header">
                <div class="activity-log-title">üìã –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</div>
                <button class="close-log-btn" onclick="toggleActivityLog()">√ó</button>
            </div>
            <div id="activityLog"></div>
        </div>
    </div>

    <script>
        // Configuration
        const _d = s => atob(s);
        const _s = {
            [_d('a3Jpcw==')]: _d('MTIzNDQzMjE='),
            [_d('bWlzaGE=')]: _d('MTIzNDQzMjE='),
            [_d('a2F0eWE=')]: _d('MTIzNDQzMjE='),
            [_d('d2FuZw==')]: _d('MTIzNDQzMjE='),
            [_d('bGlvbg==')]: _d('MTIzNDQzMjE='),
            [_d('YWxleGE=')]: _d('MDkwOTA5'),
            [_d('Ymo=')]: _d('MTIxMjEy')
        };
        const USERS = _s;

        const TIME_SLOTS = [
            '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
            '18:00', '19:00', '20:00', '21:00', '22:00', '23:00',
            '00:00', '01:00', '02:00'
        ];

        // API base URL
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : window.location.origin;

        // Security: HTML escaping to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // State
        let currentUser = null;
        let currentDate = 0;
        let scheduleData = {};
        let activityLog = [];
        let activeDates = []; // CRITICAL: Fixed dates from server (prevents midnight auto-shift)

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkSavedLogin();
            startClock();
            loadFromServer();

            // Enter key support
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });

            // Start auto-refresh
            startAutoRefresh();
        });

        function getNextThreeDates() {
            const dates = [];
            // Use Shanghai time
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));

            // CRITICAL: Day changes at 4:00 AM, not midnight!
            // If it's before 4:00 AM, we're still in "yesterday"
            if (now.getHours() < 4) {
                now.setDate(now.getDate() - 1);
            }

            for (let i = 0; i < 3; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() + i);

                const month = date.getMonth() + 1;
                const day = date.getDate();

                dates.push({
                    key: `${date.getFullYear()}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
                    display: `${day}.${month}`
                });
            }

            return dates;
        }

        function startClock() {
            updateClock();
            setInterval(updateClock, 1000);
        }

        function updateClock() {
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            if (document.getElementById('timeDisplay')) {
                document.getElementById('timeDisplay').textContent = `${hours}:${minutes}`;
            }
        }

        function checkSavedLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && USERS[savedUser]) {
                currentUser = savedUser;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateDateDisplay();
                renderSchedule();
            }
        }

        function login() {
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;

            if (USERS[username] && USERS[username] === password) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateDateDisplay();
                renderSchedule();
                logActivity(`${username} –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É`);
            } else {
                document.getElementById('errorMsg').textContent = 'Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ';
                setTimeout(() => {
                    document.getElementById('errorMsg').textContent = '';
                }, 3000);
            }
        }

        // Load data from server (NO demo data, NO localStorage fallback)
        async function loadFromServer() {
            try {
                const response = await fetch(`${API_BASE}/api/schedule`);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }

                const data = await response.json();

                // Always use server data (even if empty)
                scheduleData = data.scheduleData || {};
                activityLog = data.activityLog || [];

                // CRITICAL: Use fixed dates from server (prevents midnight auto-shift)
                activeDates = data.activeDates || getNextThreeDates();
                console.log('üìÖ Active dates from server:', activeDates.map(d => d.display).join(', '));

                updateDateDisplay();
                renderSchedule();
                updateLogDisplay();

            } catch (error) {
                console.error('‚ùå Failed to load from server:', error);
                console.error('This is FATAL - cannot work without server!');
                alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É!\n‚ö†Ô∏è Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®!');
            }
        }

        // Save data to server
        async function saveToServer() {
            try {
                console.log('üì§ Saving data to server...', {
                    tables: Object.keys(scheduleData).length,
                    logs: activityLog.length
                });

                const response = await fetch(`${API_BASE}/api/schedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scheduleData,
                        activityLog,
                        user: currentUser  // Include current user for Telegram notifications
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Data saved to server successfully');
                } else {
                    console.error('‚ùå Server responded with error:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Failed to save to server:', error);
            }
        }

        // Auto-refresh from server
        function startAutoRefresh() {
            setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/schedule`);
                    if (response.ok) {
                        const data = await response.json();
                        if (JSON.stringify(data.scheduleData) !== JSON.stringify(scheduleData)) {
                            console.log('üì• Syncing data from server');
                            scheduleData = data.scheduleData;
                            activityLog = data.activityLog || [];

                            renderSchedule();
                            updateLogDisplay();
                        }
                    }
                } catch (error) {
                    console.error('Auto-refresh failed:', error);
                }
            }, 2000);
        }

        function updateDateDisplay() {
            // Use fixed dates from server (prevents midnight auto-shift)
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            document.getElementById('tab0').textContent = dates[0].display;
            document.getElementById('tab1').textContent = dates[1].display;
            document.getElementById('tab2').textContent = dates[2].display;

            // Use Shanghai time
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
            const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
                          '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
            const dateStr = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}–≥. –≤ ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')} ‚Äî –æ–±—â–∞—è`;
            document.getElementById('dateDisplay').textContent = dateStr;
        }

        function switchDate(index) {
            currentDate = index;
            
            // Update active tab
            document.querySelectorAll('.date-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab${index}`).classList.add('active');
            
            renderSchedule();
        }

        function renderSchedule() {
            const container = document.getElementById('scheduleContainer');
            if (!container) {
                console.error('Schedule container not found');
                return;
            }

            // Use fixed dates from server (prevents midnight auto-shift)
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            // Ensure data exists for current date
            if (!scheduleData[dateKey]) {
                console.log(`Creating empty data for ${dateKey}`);
                scheduleData[dateKey] = {
                    tables: [],
                    slots: {}
                };
            }

            const currentData = scheduleData[dateKey];
            const tables = currentData.tables || [];

            console.log(`Rendering schedule for ${dateKey}:`, {
                tables: tables,
                hasSlots: !!currentData.slots
            });

            let html = '<div class="schedule-grid">';
            
            // Header row
            html += '<div class="schedule-row table-header">';
            html += '<div class="schedule-cell time-cell"></div>';
            tables.forEach(table => {
                html += `<div class="schedule-cell">${table}</div>`;
            });
            html += '</div>';
            
            // Address row
            html += '<div class="schedule-row address-row">';
            html += '<div class="schedule-cell time-cell"></div>';
            tables.forEach(table => {
                const address = escapeHtml(currentData.slots?.[table]?.address || '');
                html += `<div class="schedule-cell data-cell">
                    <input type="text" class="address-input"
                        placeholder="Âú∞ÂùÄ"
                        value="${address}"
                        onchange="updateAddress('${escapeHtml(table)}', this.value)">
                </div>`;
            });
            html += '</div>';
            
            // Time slots
            TIME_SLOTS.forEach(time => {
                html += '<div class="schedule-row">';
                html += `<div class="schedule-cell time-cell">${time}</div>`;

                tables.forEach(table => {
                    const value = currentData.slots?.[table]?.[time] || '';
                    const isSpecial = value.includes('‚ùå') || value.includes('‚öΩ') || value.includes('‚úì');
                    const escapedValue = escapeHtml(value);

                    html += `<div class="schedule-cell data-cell">
                        <input type="text" class="cell-input ${isSpecial ? 'with-icon' : ''}"
                            value="${escapedValue}"
                            onchange="updateSlot('${escapeHtml(table)}', '${escapeHtml(time)}', this.value)"
                            onfocus="this.select()">
                    </div>`;
                });

                html += '</div>';
            });

            html += '</div>';

            // Add shared notes section (visible in ALL days, synced across all days)
            // Get notes from global shared storage (not tied to specific date)
            const sharedNotes = escapeHtml(scheduleData.sharedNotes || '');
            html += `<div class="permanent-notes-section">
                <div class="notes-label">üìù –û–±—â–∏–µ –∑–∞–º–µ—Ç–∫–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤–æ –≤—Å–µ—Ö –¥–Ω—è—Ö):</div>
                <textarea class="notes-input"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏, –æ–Ω–∏ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤–æ –≤—Å–µ—Ö –¥–Ω—è—Ö..."
                    onchange="updateSharedNotes(this.value)"
                    onfocus="this.select()">${sharedNotes}</textarea>
            </div>`;

            container.innerHTML = html;
        }

        function updateAddress(table, value) {
            // Use fixed dates from server (prevents midnight auto-shift)
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey].slots) {
                scheduleData[dateKey].slots = {};
            }
            if (!scheduleData[dateKey].slots[table]) {
                scheduleData[dateKey].slots[table] = {};
            }

            scheduleData[dateKey].slots[table].address = value;
            saveToServer();
            logActivity(`${currentUser} –æ–±–Ω–æ–≤–∏–ª –∞–¥—Ä–µ—Å —Å—Ç–æ–ª–∞ ${table}`);
        }

        function updateSlot(table, time, value) {
            // Use fixed dates from server (prevents midnight auto-shift)
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey].slots) {
                scheduleData[dateKey].slots = {};
            }
            if (!scheduleData[dateKey].slots[table]) {
                scheduleData[dateKey].slots[table] = {};
            }

            scheduleData[dateKey].slots[table][time] = value;
            saveToServer();

            const action = value ? '–∑–∞–ø–∏—Å–∞–ª' : '–æ—á–∏—Å—Ç–∏–ª';
            logActivity(`${currentUser} ${action} ${time} –¥–ª—è —Å—Ç–æ–ª–∞ ${table}`);
        }

        // Update shared notes (synced across all days)
        function updateSharedNotes(value) {
            // Save to global shared notes storage (not tied to any specific date)
            scheduleData.sharedNotes = value;
            saveToServer();

            const action = value ? '–æ–±–Ω–æ–≤–∏–ª' : '–æ—á–∏—Å—Ç–∏–ª';
            logActivity(`${currentUser} ${action} –æ–±—â–∏–µ –∑–∞–º–µ—Ç–∫–∏`);
        }

        function showAddDialog() {
            // Use fixed dates from server (prevents midnight auto-shift)
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            // Ensure data exists
            if (!scheduleData[dateKey]) {
                scheduleData[dateKey] = { tables: [], slots: {} };
            }

            const currentData = scheduleData[dateKey];
            const existingTables = currentData.tables || [];
            
            // Update available options
            document.querySelectorAll('.table-option').forEach(option => {
                const tableNum = option.textContent;
                if (existingTables.includes(tableNum)) {
                    option.classList.add('disabled');
                    option.onclick = null;
                } else {
                    option.classList.remove('disabled');
                    option.onclick = () => addTable(tableNum);
                }
            });
            
            document.getElementById('overlay').classList.add('show');
            document.getElementById('addDialog').classList.add('show');
        }

        function hideAddDialog() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('addDialog').classList.remove('show');
        }

        function addTable(tableNum) {
            // Use fixed dates from server (prevents midnight auto-shift)
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            if (!scheduleData[dateKey].tables) {
                scheduleData[dateKey].tables = [];
            }

            if (!scheduleData[dateKey].tables.includes(tableNum)) {
                scheduleData[dateKey].tables.push(tableNum);
                // Sort: numeric tables first (111, 222...), then Chinese tables (Âåó‰∫¨1, Âåó‰∫¨2...)
                scheduleData[dateKey].tables.sort((a, b) => {
                    const aNum = parseInt(a);
                    const bNum = parseInt(b);
                    const aIsNum = !isNaN(aNum);
                    const bIsNum = !isNaN(bNum);

                    if (aIsNum && bIsNum) return aNum - bNum;
                    if (aIsNum && !bIsNum) return -1;
                    if (!aIsNum && bIsNum) return 1;
                    return a.localeCompare(b, 'zh-CN');
                });

                saveToServer();
                renderSchedule();
                logActivity(`${currentUser} –¥–æ–±–∞–≤–∏–ª —Å—Ç–æ–ª ${tableNum}`);
            }

            hideAddDialog();
        }

        function saveData() {
            saveToServer();
            alert('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            logActivity(`${currentUser} —Å–æ—Ö—Ä–∞–Ω–∏–ª –¥–∞–Ω–Ω—ã–µ`);
        }

        function toggleLog() {
            const log = document.getElementById('activityLog');
            log.classList.toggle('show');
        }

        function toggleActivityLog() {
            const dialog = document.getElementById('activityLogDialog');
            dialog.classList.toggle('show');
        }

        function logActivity(message) {
            // Use Shanghai time
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

            activityLog.unshift({
                time: time,
                message: message
            });

            if (activityLog.length > 50) {
                activityLog = activityLog.slice(0, 50);
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('activityLog');
            logContainer.innerHTML = activityLog.map(entry =>
                `<div class="log-entry"><span class="time">[${escapeHtml(entry.time)}]</span> ${escapeHtml(entry.message)}</div>`
            ).join('');
        }

        // Delete dialog functions
        function showDeleteDialog() {
            // Use fixed dates from server (prevents midnight auto-shift)
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;

            // Ensure data exists
            if (!scheduleData[dateKey]) {
                scheduleData[dateKey] = { tables: [], slots: {} };
            }

            const currentData = scheduleData[dateKey];
            const existingTables = currentData.tables || [];
            
            if (existingTables.length === 0) {
                alert('–ù–µ—Ç —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            const optionsHTML = existingTables.map(table => 
                `<div class="table-option" onclick="deleteTable('${table}')">${table}</div>`
            ).join('');
            
            document.getElementById('deleteOptions').innerHTML = optionsHTML;
            document.getElementById('overlay').classList.add('show');
            document.getElementById('deleteDialog').classList.add('show');
        }

        function hideDeleteDialog() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('deleteDialog').classList.remove('show');
        }

        function deleteTable(tableNum) {
            // Use fixed dates from server (prevents midnight auto-shift)
            const dates = activeDates.length > 0 ? activeDates : getNextThreeDates();
            const dateKey = dates[currentDate].key;
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü ${tableNum}?`)) {
                const index = scheduleData[dateKey].tables.indexOf(tableNum);
                if (index > -1) {
                    scheduleData[dateKey].tables.splice(index, 1);
                    
                    if (scheduleData[dateKey].slots && scheduleData[dateKey].slots[tableNum]) {
                        delete scheduleData[dateKey].slots[tableNum];
                    }

                    saveToServer();
                    renderSchedule();
                    logActivity(`${currentUser} —É–¥–∞–ª–∏–ª —Å—Ç–æ–ª ${tableNum}`);
                }
            }
            
            hideDeleteDialog();
        }


    </script>
</body>
</html>
